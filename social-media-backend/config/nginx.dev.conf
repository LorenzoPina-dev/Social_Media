# =============================================================================
# nginx.dev.conf — API Gateway per sviluppo locale
# Social Media Platform
#
# Routing:
#   /api/v1/auth/*          → auth-service:3001
#   /api/v1/users/*         → user-service:3002
#   /api/v1/posts/*         → post-service:3003
#   /api/v1/media/*         → media-service:3004
#   /api/v1/interactions/*  → interaction-service:3005
#   /api/v1/feed/*          → feed-service:3006
#   /api/v1/notifications/* → notification-service:3007
#   /api/v1/search/*        → search-service:3008
#   /api/v1/moderation/*    → moderation-service:3009
#   /health                 → risposta NGINX (gateway health)
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    # ── Upstream (load balancer pronto per scale-out) ──────────────────────────
    upstream auth_service {
        server auth-service:3001;
    }
    upstream user_service {
        server user-service:3002;
    }
    upstream post_service {
        server post-service:3003;
    }
    upstream media_service {
        server media-service:3004;
    }
    upstream interaction_service {
        server interaction-service:3005;
    }
    upstream feed_service {
        server feed-service:3006;
    }
    upstream notification_service {
        server notification-service:3007;
    }
    upstream search_service {
        server search-service:3008;
    }
    upstream moderation_service {
        server moderation-service:3009;
    }

    # ── Configurazioni generali ────────────────────────────────────────────────
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main '$remote_addr [$time_local] "$request" '
                    '$status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time urt=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M;        # media upload

    # ── Proxy headers comuni ───────────────────────────────────────────────────
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # ── Server principale ─────────────────────────────────────────────────────
    server {
        listen 80;
        server_name localhost;

        # Gateway health check
        location = /health {
            access_log off;
            return 200 '{"status":"ok","gateway":"nginx-dev"}';
            add_header Content-Type application/json;
        }

        # ── Auth Service ───────────────────────────────────────────────────────
        location /api/v1/auth/ {
            proxy_pass http://auth_service;
        }

        # ── User Service ──────────────────────────────────────────────────────
        location /api/v1/users/ {
            proxy_pass http://user_service;
        }
        location /api/v1/gdpr/ {
            proxy_pass http://user_service;
        }

        # ── Post Service ──────────────────────────────────────────────────────
        location /api/v1/posts/ {
            proxy_pass http://post_service;
        }

        # ── Media Service (upload file — timeout esteso) ──────────────────────
        location /api/v1/media/ {
            proxy_pass http://media_service;
            proxy_read_timeout 120s;
        }

        # ── Interaction Service ───────────────────────────────────────────────
        location /api/v1/interactions/ {
            proxy_pass http://interaction_service;
        }
        location /api/v1/likes/ {
            proxy_pass http://interaction_service;
        }
        location /api/v1/comments/ {
            proxy_pass http://interaction_service;
        }

        # ── Feed Service ──────────────────────────────────────────────────────
        location /api/v1/feed/ {
            proxy_pass http://feed_service;
        }

        # ── Notification Service (WebSocket upgrade supportato) ───────────────
        location /api/v1/notifications/ {
            proxy_pass http://notification_service;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400s;
        }
        location /socket.io/ {
            proxy_pass http://notification_service;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400s;
        }

        # ── Search Service ────────────────────────────────────────────────────
        location /api/v1/search/ {
            proxy_pass http://search_service;
        }

        # ── Moderation Service ────────────────────────────────────────────────
        location /api/v1/moderation/ {
            proxy_pass http://moderation_service;
        }

        # ── Fallback 404 ──────────────────────────────────────────────────────
        location / {
            return 404 '{"success":false,"error":"Route not found","code":"NOT_FOUND"}';
            add_header Content-Type application/json;
        }
    }
}
