worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    resolver 127.0.0.11 valid=10s ipv6=off;

    map $http_origin $cors_allow_origin {
        default "";
        "~^http://localhost(?::(80|3000|5173))?$" $http_origin;
        "~^http://127\.0\.0\.1:5173$" $http_origin;
    }

    upstream auth_service         { server auth-service:3001;         keepalive 16; }
    upstream user_service         { server user-service:3002;         keepalive 16; }
    upstream post_service         { server post-service:3003;         keepalive 16; }
    upstream media_service        { server media-service:3004;        keepalive 16; }
    upstream interaction_service  { server interaction-service:3005;  keepalive 16; }
    upstream feed_service         { server feed-service:3006;         keepalive 16; }
    upstream notification_service { server notification-service:3007; keepalive 16; }
    upstream search_upstream      { server search-service:3008;       keepalive 16; }
    upstream moderation_service   { server moderation-service:3009;   keepalive 16; }

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr [$time_local] "$request" $status $body_bytes_sent '
                    '"$http_origin" "$http_referer" rt=$request_time urt=$upstream_response_time';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M;

    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection        "";
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Max-Age;

    server {
        listen 80;
        server_name localhost;

        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,PATCH,OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Max-Age "86400" always;
        add_header Vary "Origin" always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        location = /health {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"status":"ok","gateway":"nginx-dev"}';
        }

        location /api/v1/auth/ {
            set $auth_upstream http://auth-service:3001;
            proxy_pass $auth_upstream;
        }

        location ~ ^/api/v1/users/[0-9a-fA-F-]+/posts(?:/.*)?$ {
            proxy_pass http://post_service;
        }
        location /api/v1/users/ {
            set $user_upstream http://user-service:3002;
            proxy_pass $user_upstream;
        }
        location /api/v1/gdpr/ {
            set $user_upstream http://user-service:3002;
            proxy_pass $user_upstream;
        }

        location /api/v1/posts/ {
            proxy_pass http://post_service;
        }

        location /api/v1/media/ {
            proxy_pass http://media_service;
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;
        }

        location /api/v1/interactions/ {
            proxy_pass http://interaction_service;
        }
        location /api/v1/likes/ {
            proxy_pass http://interaction_service;
        }
        location /api/v1/comments/ {
            proxy_pass http://interaction_service;
        }

        location /api/v1/feed/ {
            proxy_pass http://feed_service;
        }

        location /api/v1/notifications/ {
            set $notification_upstream http://notification-service:3007;
            proxy_pass $notification_upstream;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "upgrade";
            proxy_read_timeout 86400s;
        }

        location /api/v1/messages/ {
            set $user_upstream http://user-service:3002;
            proxy_pass $user_upstream;
        }

        location /notifications/ {
            set $notification_upstream http://notification-service:3007;
            proxy_pass $notification_upstream;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "upgrade";
            proxy_read_timeout 86400s;
        }

        location /socket.io/ {
            set $notification_upstream http://notification-service:3007;
            proxy_pass $notification_upstream;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "upgrade";
            proxy_read_timeout 86400s;
        }

        location /api/v1/search/ {
            proxy_pass http://search_upstream;
        }

        location /api/v1/moderation/ {
            proxy_pass http://moderation_service;
        }

        location / {
            add_header Content-Type application/json;
            return 404 '{"success":false,"error":"Route not found","code":"NOT_FOUND"}';
        }
    }
}
